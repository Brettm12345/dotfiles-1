#!/bin/sh
#
# notifyd - notification daemon
# (c) tudurom 2016 - wtfpl
#

NOTIFY_FIFO_PATH=${NOTIFY_FIFO_PATH:-$HOME/tmp/notifyd.fifo}
NOTIFY_COUNTER_PATH=${NOTIFY_COUNTER_PATH:-$HOME/tmp/notifyd.cnt}

# create fifo
test -p $NOTIFY_FIFO_PATH || mkfifo $NOTIFY_FIFO_PATH

# display vars
DISPLAY_X="$(dattr -x `ppd`)"
DISPLAY_Y="$(dattr -y `ppd`)"
DISPLAY_W="$(dattr -w `ppd`)"
DISPLAY_H="$(dattr -h `ppd`)"

NOTIFY_W="$(( 110 + 2 * PANEL_INNER_GAP ))"
NOTIFY_H="$(( $PANEL_STATUS_HEIGHT ))"
NOTIFY_X="$(( DISPLAY_X + GENERAL_GAP + 300 + GENERAL_GAP ))"
NOTIFY_Y="$(( DISPLAY_Y + GENERAL_GAP ))"

n=0
echo "$n" > "$NOTIFY_COUNTER_PATH"
tail -f "$NOTIFY_FIFO_PATH" | \
while IFS= read -r message; do
  # increment counter
  n="$(cat "$NOTIFY_COUNTER_PATH")"
  n="$(( n + 1 ))"
  echo "$n" > "$NOTIFY_COUNTER_PATH"

  {
      popup $(( NOTIFY_X + (n - 1) * (NOTIFY_W + GENERAL_GAP) )) $NOTIFY_Y $NOTIFY_W $NOTIFY_H "$message"
    n="$(cat "$NOTIFY_COUNTER_PATH")"
    n="$(( n - 1 ))"
    echo "$n" > "$NOTIFY_COUNTER_PATH"
  } &
done
